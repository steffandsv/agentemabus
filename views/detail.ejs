<%- include('partials/header') %>

<div class="row mb-3 align-items-center">
    <div class="col-md-8">
        <h2 class="brand-font text-white mb-0"><%= task.name %></h2>
        <div class="d-flex align-items-center gap-2 text-muted small mt-1">
            <span><i class="fas fa-cube"></i> <%= task.id %></span>
            <span>|</span>
            <span><i class="fas fa-map-marker-alt"></i> <%= task.cep %></span>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <a href="/dashboard" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i> VOLTAR</a>
        <% if (task.status === 'completed') { %>
            <a href="/download/<%= task.id %>" class="btn btn-success btn-sm shadow-green"><i class="fas fa-file-excel"></i> RELATÓRIO</a>
        <% } %>
    </div>
</div>

<div class="row g-4">
    <!-- LEFT: SNIPER LIST -->
    <div class="col-lg-8">

        <!-- STATUS BAR -->
        <div class="card bg-panel border-secondary mb-3">
            <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                <span class="small text-muted uppercase">STATUS OPERACIONAL</span>
                <div>
                    <% if (task.status === 'running') { %>
                        <span class="text-neon blink"><i class="fas fa-satellite-dish"></i> ESCANEANDO MERCADO...</span>
                    <% } else if (task.status === 'completed') { %>
                        <span class="text-success"><i class="fas fa-check"></i> MISSÃO CUMPRIDA</span>
                    <% } else { %>
                        <span class="text-muted"><%= task.status.toUpperCase() %></span>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- ITEMS GRID -->
        <div class="card bg-black border-secondary">
            <div class="card-header bg-transparent border-secondary text-white">
                <i class="fas fa-list-ol"></i> RESULTADOS TÁTICOS
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 align-middle small">
                    <thead>
                        <tr class="text-muted">
                            <th>ALVO</th>
                            <th class="text-end">MAX (R$)</th>
                            <th class="text-end">SNIPER (R$)</th>
                            <th class="text-center">STATUS</th>
                            <th class="text-end">AÇÃO</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (taskItems.length === 0) { %>
                            <tr><td colspan="5" class="text-center text-muted py-4">Aguardando dados...</td></tr>
                        <% } %>
                        <% taskItems.forEach(item => {
                            const hasPrice = item.best_price > 0;
                            const profit = item.valor_venda - item.best_price;
                            const margin = (profit / item.valor_venda) * 100;
                            const isWin = hasPrice && profit >= 0;
                        %>
                        <tr>
                            <td>
                                <div class="text-white fw-bold"><%= item.description.substring(0, 40) %>...</div>
                                <div class="text-muted" style="font-size: 0.75rem;">Qtd: <%= item.quantidade %></div>
                            </td>
                            <td class="text-end text-muted"><%= item.valor_venda.toFixed(2) %></td>
                            <td class="text-end">
                                <% if (hasPrice) { %>
                                    <span class="<%= isWin ? 'text-success' : 'text-danger' %> fw-bold">
                                        <%= item.best_price.toFixed(2) %>
                                    </span>
                                <% } else { %>
                                    <span class="text-muted">---</span>
                                <% } %>
                            </td>
                            <td class="text-center">
                                <% if (isWin) { %>
                                    <span class="badge bg-success text-dark"><i class="fas fa-arrow-up"></i> <%= margin.toFixed(0) %>%</span>
                                <% } else if (hasPrice) { %>
                                    <span class="badge bg-danger text-dark"><i class="fas fa-arrow-down"></i></span>
                                <% } else { %>
                                    <span class="spinner-grow spinner-grow-sm text-secondary" style="width: 0.5rem; height: 0.5rem;"></span>
                                <% } %>
                            </td>
                            <td class="text-end">
                                <% if (hasPrice) { %>
                                    <button class="btn btn-outline-warning btn-sm py-0" style="font-size: 0.7rem;">
                                        <i class="fas fa-lock"></i>
                                    </button>
                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- RIGHT: TERMINAL & STATS -->
    <div class="col-lg-4">

        <!-- TERMINAL TOGGLE -->
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header bg-transparent border-secondary d-flex justify-content-between cursor-pointer" onclick="toggleTerminal()">
                <span class="text-muted small"><i class="fas fa-terminal"></i> LOGS DO SISTEMA</span>
                <i class="fas fa-chevron-down text-muted" id="term-icon"></i>
            </div>
            <div class="card-body p-0" id="terminal-body" style="display:none;">
                <pre id="logs" class="p-3 m-0 bg-black text-success small border-0" style="height: 300px; overflow-y: auto; font-family: monospace;"></pre>
            </div>
        </div>

        <!-- STATS CARD -->
        <div class="card card-gold">
            <div class="card-body text-center">
                <h6 class="text-muted small uppercase mb-3">LUCRO PROJETADO</h6>
                <%
                    let totalProfit = 0;
                    taskItems.forEach(i => {
                        if (i.best_price > 0 && i.best_price < i.valor_venda) {
                            totalProfit += (i.valor_venda - i.best_price) * i.quantidade;
                        }
                    });
                %>
                <h2 class="display-4 text-warning fw-bold mb-0">R$ <%= totalProfit.toFixed(2) %></h2>
                <div class="mt-3">
                    <button class="btn btn-warning w-100 shadow-gold fw-bold">
                        <i class="fas fa-bolt"></i> DESBLOQUEAR RELATÓRIO
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const taskId = '<%= task.id %>';

    function toggleTerminal() {
        const body = document.getElementById('terminal-body');
        const icon = document.getElementById('term-icon');
        if (body.style.display === 'none') {
            body.style.display = 'block';
            icon.className = 'fas fa-chevron-up text-white';
        } else {
            body.style.display = 'none';
            icon.className = 'fas fa-chevron-down text-muted';
        }
    }

    // Simple Log Fetcher
    setInterval(() => {
        fetch('/api/logs/' + taskId)
            .then(r => r.text())
            .then(text => {
                const el = document.getElementById('logs');
                if (el.innerText !== text) {
                    el.innerText = text;
                    el.scrollTop = el.scrollHeight;
                }
            });
    }, 2000);

    // Auto-refresh page on completion? Or just partial?
    // For now, let's just refresh if status changes
    const currentStatus = '<%= task.status %>';
    if (currentStatus === 'running' || currentStatus === 'pending') {
        setInterval(() => {
            // Check status via logs or new API?
            // Ideally we'd have a status API.
            // We can infer from logs if "Finalizado" appears, or just reload every 10s
        }, 10000);
    }
</script>

<%- include('partials/footer') %>
