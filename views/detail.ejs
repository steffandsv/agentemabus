<%- include('partials/header') %>

<div class="row mb-3 align-items-center">
    <div class="col-md-8">
        <h2 class="brand-font text-white mb-0"><%= task.name %></h2>
        <div class="d-flex align-items-center gap-2 text-muted small mt-1">
            <span><i class="fas fa-cube"></i> <%= task.id %></span>
            <span>|</span>
            <span><i class="fas fa-map-marker-alt"></i> <%= task.cep %></span>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <a href="/dashboard" class="btn btn-outline-secondary btn-sm glass-button"><i class="fas fa-arrow-left"></i> VOLTAR</a>
        <% if (task.status === 'running' || task.status === 'pending') { %>
            <button onclick="abortMission()" class="btn btn-danger btn-sm shadow-red glass-button"><i class="fas fa-ban"></i> ABORTAR MISSÃO</button>
        <% } %>
        <%
           // Check if there are any unlocked items
           const anyUnlocked = taskItems.some(item => item.is_unlocked);
           // Allow download if there are unlocked items AND task is not just pending (has some data potentially)
           if (task.status !== 'pending' && anyUnlocked) {
        %>
             <a href="/download/<%= task.id %>" class="btn btn-success btn-sm shadow-green glass-button"><i class="fas fa-file-excel"></i> RELATÓRIO (DESBLOQUEADOS)</a>
        <% } %>
    </div>
</div>

<div class="row g-4">
    <!-- LEFT: SNIPER LIST -->
    <div class="col-lg-8">

        <!-- STATUS BAR -->
        <div class="card bg-panel border-secondary mb-3">
            <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                <span class="small text-muted uppercase">STATUS OPERACIONAL</span>
                <div>
                    <% if (task.status === 'running') { %>
                        <span class="text-neon blink"><i class="fas fa-satellite-dish"></i> ESCANEANDO MERCADO...</span>
                    <% } else if (task.status === 'completed') { %>
                        <span class="text-success"><i class="fas fa-check"></i> MISSÃO CUMPRIDA</span>
                    <% } else { %>
                        <span class="text-muted"><%= task.status.toUpperCase() %></span>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- ITEMS GRID -->
        <div class="card bg-black border-secondary">
            <div class="card-header bg-transparent border-secondary text-white">
                <i class="fas fa-list-ol"></i> RESULTADOS TÁTICOS
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 align-middle small">
                    <thead>
                        <tr class="text-muted">
                            <th>ALVO</th>
                            <th class="text-end">MAX (R$)</th>
                            <th class="text-end">SNIPER (R$)</th>
                            <th class="text-center">STATUS</th>
                            <th class="text-end">AÇÃO</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (taskItems.length === 0) { %>
                            <tr><td colspan="5" class="text-center text-muted py-4">Aguardando dados...</td></tr>
                        <% } %>
                        <% taskItems.forEach(item => {
                            const hasPrice = item.best_price > 0;
                            const profit = item.valor_venda - item.best_price;
                            const margin = (profit / item.valor_venda) * 100;
                            const isWin = hasPrice && profit >= 0;
                            const isUnlocked = item.is_unlocked;
                        %>
                        <tr>
                            <td>
                                <div class="text-white fw-bold"><%= item.description.substring(0, 40) %>...</div>
                                <div class="text-muted" style="font-size: 0.75rem;">Qtd: <%= item.quantidade %></div>
                            </td>
                            <td class="text-end text-muted"><%= item.valor_venda.toFixed(2) %></td>
                            <td class="text-end">
                                <% if (hasPrice) { %>
                                    <% if (isUnlocked) { %>
                                        <span class="<%= isWin ? 'text-success' : 'text-danger' %> fw-bold">
                                            R$ <%= item.best_price.toFixed(2) %>
                                        </span>
                                    <% } else { %>
                                        <span class="blurred-text">R$ 0000.00</span>
                                    <% } %>
                                <% } else { %>
                                    <span class="text-muted">---</span>
                                <% } %>
                            </td>
                            <td class="text-center">
                                <% if (isWin) { %>
                                    <span class="badge bg-success text-dark"><i class="fas fa-arrow-up"></i> <%= margin.toFixed(0) %>%</span>
                                <% } else if (hasPrice) { %>
                                    <span class="badge bg-danger text-dark"><i class="fas fa-arrow-down"></i></span>
                                <% } else { %>
                                    <% if (task.status === 'running') { %>
                                        <span class="spinner-grow spinner-grow-sm text-secondary" style="width: 0.5rem; height: 0.5rem;"></span>
                                    <% } else { %>
                                        <span class="text-muted">-</span>
                                    <% } %>
                                <% } %>
                            </td>
                            <td class="text-end">
                                <% if (hasPrice) { %>
                                    <% if (isUnlocked) { %>
                                        <a href="/download/<%= task.id %>/item/<%= item.db_id %>" class="btn btn-success btn-sm py-0 glass-button" title="Baixar Item">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    <% } else { %>
                                        <button onclick="unlockItem('<%= item.db_id %>')" class="btn btn-outline-warning btn-sm py-0 glass-button" style="font-size: 0.7rem;">
                                            <i class="fas fa-lock"></i> 150 W
                                        </button>
                                    <% } %>
                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- RIGHT: TERMINAL & STATS -->
    <div class="col-lg-4">

        <!-- TERMINAL TOGGLE -->
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header bg-transparent border-secondary d-flex justify-content-between cursor-pointer" onclick="toggleTerminal()">
                <span class="text-muted small"><i class="fas fa-terminal"></i> LOGS DO SISTEMA</span>
                <i class="fas fa-chevron-down text-muted" id="term-icon"></i>
            </div>
            <div class="card-body p-0" id="terminal-body" style="display:none;">
                <pre id="logs" class="p-3 m-0 bg-black text-success small border-0" style="height: 300px; overflow-y: auto; font-family: monospace;"></pre>
            </div>
        </div>

        <!-- STATS CARD -->
        <div class="card card-gold glass-panel">
            <div class="card-body text-center">
                <h6 class="text-muted small uppercase mb-3">LUCRO PROJETADO (POTENCIAL)</h6>
                <%
                    let totalProfit = 0;
                    let lockedCount = 0;
                    taskItems.forEach(i => {
                        if (i.best_price > 0 && i.best_price < i.valor_venda) {
                            totalProfit += (i.valor_venda - i.best_price) * i.quantidade;
                        }
                        if (!i.is_unlocked) lockedCount++;
                    });

                    const unlockAllCost = lockedCount * 75;
                %>
                <h2 class="display-4 text-warning fw-bold mb-0">R$ <%= totalProfit.toFixed(2) %></h2>

                <% if (lockedCount > 0) { %>
                    <div class="mt-3">
                        <p class="small text-muted mb-2"><%= lockedCount %> Itens Bloqueados</p>
                        <button onclick="unlockAll()" class="btn btn-warning w-100 shadow-gold fw-bold glass-button">
                            <i class="fas fa-bolt"></i> DESBLOQUEAR TUDO (<%= unlockAllCost %> W)
                            <br><span style="font-size: 0.7rem; font-weight: normal;">50% DE DESCONTO APLICADO</span>
                        </button>
                    </div>
                <% } else { %>
                    <div class="mt-3">
                        <div class="alert alert-success bg-transparent border-success text-success">
                            <i class="fas fa-check-circle"></i> ACESSO TOTAL LIBERADO
                        </div>
                    </div>
                <% } %>
            </div>
        </div>

    </div>
</div>

<script>
    const taskId = '<%= task.id %>';

    function toggleTerminal() {
        const body = document.getElementById('terminal-body');
        const icon = document.getElementById('term-icon');
        if (body.style.display === 'none') {
            body.style.display = 'block';
            icon.className = 'fas fa-chevron-up text-white';
        } else {
            body.style.display = 'none';
            icon.className = 'fas fa-chevron-down text-muted';
        }
    }

    // Simple Log Fetcher
    setInterval(() => {
        fetch('/api/logs/' + taskId)
            .then(r => r.text())
            .then(text => {
                const el = document.getElementById('logs');
                if (el.innerText !== text) {
                    el.innerText = text;
                    el.scrollTop = el.scrollHeight;
                }
            });
    }, 2000);

    async function abortMission() {
        if (!confirm('Tem certeza? Isso irá parar o processo e não poderá ser revertido.')) return;
        try {
            const res = await fetch('/api/task/' + taskId + '/abort', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch(e) { alert('Erro de conexão'); }
    }

    async function unlockItem(itemDbId) {
        if (!confirm('Desbloquear este item por 150 Watts?')) return;
        try {
            const res = await fetch('/api/unlock-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ itemId: itemDbId })
            });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erro: ' + (data.error || 'Saldo insuficiente ou erro desconhecido.'));
            }
        } catch(e) { alert('Erro de conexão'); }
    }

    async function unlockAll() {
        if (!confirm('Desbloquear TODOS os itens com 50% de desconto?')) return;
        try {
            const res = await fetch('/api/unlock-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId: taskId })
            });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erro: ' + (data.error || 'Saldo insuficiente ou erro desconhecido.'));
            }
        } catch(e) { alert('Erro de conexão'); }
    }

    // Auto-refresh page on completion
    const currentStatus = '<%= task.status %>';
    if (currentStatus === 'running' || currentStatus === 'pending') {
        setTimeout(() => {
           window.location.reload();
        }, 10000);
    }
</script>

<%- include('partials/footer') %>
