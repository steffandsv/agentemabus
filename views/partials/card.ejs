<div class="kanban-card status-<%= task.status %>" data-id="<%= task.id %>" data-tags='<%= task.tags || "[]" %>' onclick="window.location.href='/task/<%= task.id %>'">
    <div class="card-tags">
        <% 
        let tags = [];
        try { tags = typeof task.tags === 'string' ? JSON.parse(task.tags) : (task.tags || []); } catch(e) {}
        tags.forEach(tag => { 
        %>
            <span class="tag-badge" style="background-color: <%= tag.color %>"><%= tag.name %></span>
        <% }) %>
        <button class="btn btn-sm btn-light py-0 px-1" style="font-size: 0.7em" onclick="openTagModal('<%= task.id %>')">+</button>
    </div>
    
    <div class="fw-bold mb-1"><%= task.name %></div>
    <div class="text-muted small mb-2"><i class="bi bi-clock"></i> <%= new Date(task.created_at).toLocaleDateString('pt-BR') %> <%= new Date(task.created_at).toLocaleTimeString('pt-BR').substring(0,5) %></div>

    <div class="card-actions" onclick="event.stopPropagation()">
        <!-- S.O.U Button -->
        <% if (task.external_link) { %>
            <a href="<%= task.external_link %>" target="_blank" class="btn btn-sm btn-outline-primary" title="S.O.U (Link Externo)">
                S.O.U <i class="bi bi-box-arrow-up-right"></i>
            </a>
        <% } else { %>
            <span class="text-muted small">Sem Link</span>
        <% } %>

        <!-- Dropdown Actions -->
        <div class="dropdown">
            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
                <% if (task.status === 'pending' || task.status === 'queued') { %>
                    <li>
                        <form action="/task/<%= task.id %>/force-start" method="POST">
                            <button type="submit" class="dropdown-item"><i class="bi bi-play-fill"></i> Forçar Início</button>
                        </form>
                    </li>
                <% } %>
                
                <% if (task.status === 'running' || task.status === 'pending' || task.status === 'queued') { %>
                    <li>
                        <form action="/task/<%= task.id %>/action" method="POST">
                            <input type="hidden" name="action" value="abort">
                            <button type="submit" class="dropdown-item text-danger"><i class="bi bi-stop-circle"></i> Abortar</button>
                        </form>
                    </li>
                <% } %>

                <% if (task.status === 'completed') { %>
                    <li><a class="dropdown-item" href="/download/<%= task.id %>"><i class="bi bi-file-earmark-excel"></i> Baixar Excel</a></li>
                <% } %>
                
                <% if (task.status === 'completed' || task.status === 'failed' || task.status === 'aborted') { %>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form action="/task/<%= task.id %>/action" method="POST">
                            <input type="hidden" name="action" value="archive">
                            <button type="submit" class="dropdown-item"><i class="bi bi-archive"></i> Arquivar</button>
                        </form>
                    </li>
                <% } %>
            </ul>
        </div>
    </div>
</div>
