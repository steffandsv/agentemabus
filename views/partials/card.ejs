<div class="card bg-dark border-secondary mb-3 shadow-sm status-<%= task.status %>" style="border-left: 4px solid <%= task.status === 'completed' ? '#198754' : (task.status === 'failed' ? '#dc3545' : '#0d6efd') %>;" onclick="window.location.href='/task/<%= task.id %>'">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title text-white mb-0 text-truncate" style="max-width: 70%;"><%= task.name %></h5>

            <!-- Status Badge -->
            <% if (task.status === 'completed') { %>
                <span class="badge bg-success">Concluído</span>
            <% } else if (task.status === 'failed') { %>
                <span class="badge bg-danger">Falhou</span>
            <% } else if (task.status === 'running') { %>
                <span class="badge bg-primary spinner-border spinner-border-sm"></span>
            <% } else { %>
                <span class="badge bg-secondary">Pendente</span>
            <% } %>
        </div>

        <p class="card-text text-muted small mb-2">
            <i class="fas fa-map-marker-alt"></i> <%= task.cep || 'N/A' %>
        </p>

        <!-- Tags -->
        <div class="mb-3">
            <%
            let tags = [];
            try { tags = typeof task.tags === 'string' ? JSON.parse(task.tags) : (task.tags || []); } catch(e) {}
            tags.forEach(tag => {
            %>
                <span class="badge me-1" style="background-color: <%= tag.color %>"><%= tag.name %></span>
            <% }) %>
            <button class="btn btn-sm btn-outline-secondary py-0 px-1 text-white" style="font-size: 0.7em" onclick="openTagModal('<%= task.id %>'); event.stopPropagation();">+</button>
        </div>

        <div class="d-flex justify-content-between align-items-center" onclick="event.stopPropagation()">
            <!-- Actions -->
            <div class="btn-group">
                <% if (task.external_link) { %>
                    <a href="<%= task.external_link %>" target="_blank" class="btn btn-sm btn-outline-info" title="Link Externo"><i class="fas fa-external-link-alt"></i></a>
                <% } %>
                
                <% if (task.status === 'completed') { %>
                    <a href="/download/<%= task.id %>" class="btn btn-sm btn-success" title="Baixar Excel"><i class="fas fa-file-excel"></i></a>
                <% } %>

                <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-dark">
                    <% if (task.status === 'pending') { %>
                        <li>
                            <form action="/task/<%= task.id %>/force-start" method="POST">
                                <button type="submit" class="dropdown-item"><i class="fas fa-play"></i> Forçar Início</button>
                            </form>
                        </li>
                    <% } %>
                    <li>
                        <form action="/task/<%= task.id %>/action" method="POST">
                            <input type="hidden" name="action" value="archive">
                            <button type="submit" class="dropdown-item"><i class="fas fa-archive"></i> Arquivar</button>
                        </form>
                    </li>
                </ul>
            </div>

            <small class="text-muted"><%= new Date(task.created_at).toLocaleDateString('pt-BR') %></small>
        </div>
    </div>
</div>
