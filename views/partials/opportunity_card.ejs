
<%
// Helper to determine Card Class based on IPM Score
function getCardClass(score) {
    if (score >= 80) return 'card-gold'; // Gold
    if (score >= 50) return 'card-silver'; // Silver/Blue
    return 'card-bronze'; // Bronze/Common
}

function getBadgeColor(score) {
    if (score >= 80) return 'bg-warning text-dark';
    if (score >= 50) return 'bg-primary';
    return 'bg-secondary';
}

function getTierName(score) {
    if (score >= 80) return 'NÍVEL OURO';
    if (score >= 50) return 'NÍVEL PRATA';
    return 'NÍVEL BRONZE';
}
%>

<div class="col-md-4 mb-4">
    <div class="card h-100 <%= getCardClass(opp.ipm_score) %> position-relative" style="overflow: hidden; border: 1px solid #333;">
        <div class="card-body d-flex flex-column">

            <!-- Header -->
            <div class="d-flex justify-content-between mb-2">
                <span class="badge <%= getBadgeColor(opp.ipm_score) %>"><%= getTierName(opp.ipm_score) %></span>
                <span class="text-white small fw-bold">IPM: <%= opp.ipm_score %></span>
            </div>

            <!-- Title & Subtitle -->
            <h5 class="card-title text-white" style="text-shadow: 0 0 5px rgba(0,0,0,0.8);">
                <%= opp.municipality || 'Município Desconhecido' %>
            </h5>
            <h6 class="card-subtitle mb-2 text-gray-400 small">
                <%= opp.title || 'Edital Sem Número' %>
            </h6>

            <!-- Content Area -->
            <% if (isLocked) { %>
                <!-- LOCKED VIEW (For Radar/Admin items viewed by User) -->

                <div class="blurred-content my-3" style="filter: blur(4px); opacity: 0.5;">
                    <p class="card-text small text-gray-500">
                        Análise completa oculta. Detalhes estratégicos e lista de itens protegidos.
                        <br><br>
                        Identificado: <%= opp.metadata_json.tipo_objeto_principal || 'Objeto' %>
                    </p>
                </div>

                <div class="lock-overlay w-100 px-3 text-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;">
                    <h5 class="text-warning mb-1" style="text-shadow: 0 0 10px #000;">OPORTUNIDADE</h5>
                    <p class="small text-white mb-2" style="text-shadow: 0 0 10px #000;">
                        <%= opp.metadata_json.tipo_objeto_principal || 'Diversos' %>
                    </p>

                    <% if (opp.metadata_json.tags_estrategicas && opp.metadata_json.tags_estrategicas.length > 0) { %>
                        <div class="mb-2">
                        <% opp.metadata_json.tags_estrategicas.slice(0, 2).forEach(tag => { %>
                            <span class="badge bg-dark border border-secondary text-gray-300 small me-1"><%= tag %></span>
                        <% }) %>
                        </div>
                    <% } %>

                    <button class="btn btn-sm w-100 btn-outline-warning disabled" style="opacity: 0.8;">
                        <i class="fas fa-lock"></i> VISUALIZAÇÃO APENAS
                    </button>
                </div>

            <% } else { %>
                <!-- UNLOCKED VIEW (User's own history or Unlocked Radar) -->
                <p class="card-text small text-gray-300 flex-grow-1">
                    <%= opp.metadata_json.resumo_teaser || 'Sem resumo disponível.' %>
                </p>

                <!-- Tags -->
                <div class="mb-3">
                    <% if (opp.metadata_json.tags_estrategicas) { %>
                        <% opp.metadata_json.tags_estrategicas.slice(0, 3).forEach(tag => { %>
                            <span class="badge bg-dark border border-secondary text-info small me-1"><%= tag %></span>
                        <% }) %>
                    <% } %>
                </div>

                <!-- Footer Info -->
                <div class="mt-auto pt-3 border-top border-secondary">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-success fw-bold" style="text-shadow: 0 0 5px rgba(0,255,0,0.3);">
                            <%= opp.metadata_json.valor_estimado_total || 'R$ Sigiloso' %>
                        </span>
                        <span class="text-gray-400 small">
                            <%= new Date(opp.created_at).toLocaleDateString('pt-BR') %>
                        </span>
                    </div>
                    <!-- Action: Open Modal or Details -->
                    <button class="btn btn-outline-light btn-sm w-100" onclick="openOpportunityDetails(<%= opp.id %>)">
                        <i class="fas fa-eye"></i> VER DETALHES
                    </button>
                </div>
            <% } %>

        </div>
    </div>
</div>
