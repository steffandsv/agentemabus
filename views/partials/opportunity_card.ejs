<%
// Helper to determine Card Class based on IPM Score
function getCardClass(score) {
    return 'card';
}

function getBadgeClass(score) {
    if (score >= 80) return 'badge--warning'; // Gold-ish
    if (score >= 50) return 'badge--success'; // Good
    return 'badge--default'; // Common
}

function getTierName(score) {
    if (score >= 80) return 'ALTA RELEVÂNCIA';
    if (score >= 50) return 'MÉDIA RELEVÂNCIA';
    return 'BAIXA RELEVÂNCIA';
}
%>

<article class="<%= getCardClass(opp.ipm_score) %>">
    <!-- Header -->
    <div class="card-header">
        <div class="d-flex flex-column">
            <h3 class="card-title"><%= opp.municipality || 'Município Desconhecido' %></h3>
            <span class="card-meta"><%= opp.title || 'Edital Sem Número' %></span>
        </div>
        <span class="badge <%= getBadgeClass(opp.ipm_score) %>"><%= getTierName(opp.ipm_score) %></span>
    </div>

    <div class="card-divider"></div>

    <!-- Body -->
    <div class="card-body">
        <% if (isLocked) { %>
            <!-- LOCKED CONTENT -->
            <div style="filter: blur(5px); user-select: none;">
                <div class="data-pair">
                    <span class="label">Resumo</span>
                    <span class="value">Conteúdo protegido para visualização estratégica.</span>
                </div>
                <div class="data-pair mt-3">
                    <span class="label">Valor Estimado</span>
                    <span class="value value--large">R$ ---.---,--</span>
                </div>
            </div>

            <div style="position: absolute; top: 50%; left: 0; width: 100%; text-align: center; z-index: 10;">
                <span class="badge badge--warning"><i class="fas fa-lock me-1"></i> RESTRITO</span>
            </div>
        <% } else { %>
            <!-- UNLOCKED CONTENT -->
            <div class="data-pair">
                <span class="label">Resumo</span>
                <span class="value"><%= opp.metadata_json.resumo_teaser || 'Sem resumo disponível.' %></span>
            </div>

            <div class="d-flex gap-2 mt-3 flex-wrap">
                <% if (opp.metadata_json.tags_estrategicas) { %>
                    <% opp.metadata_json.tags_estrategicas.slice(0, 3).forEach(tag => { %>
                        <span class="badge badge--default"><%= tag %></span>
                    <% }) %>
                <% } %>
            </div>

            <div class="data-pair mt-4">
                <span class="label">Valor Estimado</span>
                <span class="value value--large"><%= opp.metadata_json.valor_estimado_total || 'Sob Consulta' %></span>
            </div>
        <% } %>
    </div>

    <!-- Footer -->
    <div class="card-footer">
        <% if (!isLocked) { %>
            <button class="btn btn--secondary btn-sm">Comparar</button>
            <button class="btn btn--primary btn-sm" onclick="openOpportunityDetails(<%= opp.id %>)">Ver Detalhes</button>
        <% } else { %>
             <button class="btn btn--secondary btn-sm" disabled>Bloqueado</button>
        <% } %>
    </div>
</article>
