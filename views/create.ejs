<%- include('partials/header') %>

<div class="row justify-content-center">
    <div class="col-md-8">
        <h2 class="mb-4">‚ú® Nova Miss√£o</h2>
        <div class="card shadow">
            <div class="card-body">
                <!-- AI TR Processor - MOVED TO TOP -->
                <div class="mb-4 p-3 bg-light rounded border">
                    <h5 class="mb-3">ü§ñ Automa√ß√£o com I.A</h5>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-warning me-3" onclick="document.getElementById('trFile').click()">
                            <i class="fas fa-magic"></i> Processar Editais/TRs com I.A
                        </button>
                        <input type="file" id="trFile" accept=".pdf" style="display: none;" multiple onchange="uploadTR(this)">
                        <span id="ai-status" class="text-muted">Carregue um ou mais PDFs para preenchimento autom√°tico.</span>
                    </div>
                </div>

                <form action="/create" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="metadataJSON" id="metadataJSON">

                    <div class="mb-3">
                        <label class="form-label">Nome da Tarefa</label>
                        <input type="text" name="name" id="taskName" class="form-control" required placeholder="Ex: Cota√ß√£o TI - Lote 1">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">CEP de Destino</label>
                        <input type="text" name="cep" id="taskCep" class="form-control" required placeholder="00000-000">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Link com mais detalhes</label>
                        <input type="text" name="external_link" class="form-control" placeholder="https://...">
                        <div class="form-text">Link para mais detalhes do processo.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">M√≥dulo de IA</label>
                        <select name="moduleName" class="form-select">
                            <% modules.forEach(function(mod) { %>
                                <option value="<%= mod %>" <%= mod === 'smart' ? 'selected' : '' %>><%= mod %></option>
                            <% }); %>
                        </select>
                        <div class="form-text">Selecione qual "c√©rebro" executar√° a tarefa. O padr√£o agora √© "Smart" (Gemini+Meli com fallback para Perplexity).</div>
                    </div>

                    <% if (userGroups && userGroups.length > 0) { %>
                    <div class="mb-3">
                        <label class="form-label">Grupo de Visibilidade</label>
                        <select name="group_id" class="form-select">
                            <option value="">-- Pessoal (Apenas Eu) --</option>
                            <% userGroups.forEach(function(group) { %>
                                <option value="<%= group.id %>"><%= group.name %></option>
                            <% }); %>
                        </select>
                        <div class="form-text">Selecione um grupo para compartilhar esta tarefa com outros membros.</div>
                    </div>
                    <% } %>

                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h5 class="card-title">Dados de Entrada</h5>
                            
                            <!-- Interactive Grid for Everyone -->
                            <div id="grid-container">
                                <div class="alert alert-info">
                                    <strong>Cr√©ditos Dispon√≠veis:</strong> <span id="user-credits"><%= user.current_credits %></span>
                                    <br>
                                    <strong>Custo Estimado:</strong> <span id="estimated-cost">0</span> cr√©ditos (1 por item)
                                    <% if (user.role === 'admin') { %>
                                        <span class="badge bg-warning text-dark">Admin (Isento)</span>
                                    <% } %>
                                </div>

                                <table class="table table-bordered table-sm" id="items-grid">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 5%">#</th>
                                            <th style="width: 60%">Descri√ß√£o do Item</th>
                                            <th style="width: 15%">Max Pre√ßo (R$)</th>
                                            <th style="width: 10%">Qtd</th>
                                            <th style="width: 10%">A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-body">
                                        <!-- Rows added dynamically -->
                                    </tbody>
                                </table>
                                <div class="d-flex justify-content-between mb-3">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-success" id="btnAddRow" onclick="addRow()"><i class="fas fa-plus"></i> Adicionar Item</button>
                                        <button type="button" class="btn btn-sm btn-primary" id="btnConfirm" onclick="toggleEdit()"><i class="fas fa-check"></i> Confirmar Itens</button>
                                    </div>

                                    <!-- Fallback File Upload for Admins or manual users -->
                                    <div class="input-group input-group-sm w-auto">
                                        <label class="input-group-text" for="fallbackCsv">Ou importar CSV</label>
                                        <input type="file" class="form-control" id="fallbackCsv" name="csvFile" accept=".csv">
                                    </div>
                                </div>

                                <input type="hidden" name="gridData" id="gridData">
                            </div>

                            <script>
                                let rowCount = 0;
                                let isLocked = false;
                                const userCredits = <%= user.current_credits %>;
                                const isAdmin = <%= user.role === 'admin' %>;

                                function addRow() {
                                    if(isLocked) return;
                                    rowCount++;
                                    const tbody = document.getElementById('items-body');
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `
                                        <td>${rowCount}</td>
                                        <td><input type="text" class="form-control form-control-sm" placeholder="Ex: Notebook Dell i7" required></td>
                                        <td><input type="number" step="0.01" class="form-control form-control-sm" placeholder="0.00" required></td>
                                        <td><input type="number" class="form-control form-control-sm" value="1" required></td>
                                        <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">X</button></td>
                                    `;
                                    tbody.appendChild(tr);
                                    updateCost();
                                }

                                function removeRow(btn) {
                                    if(isLocked) return;
                                    btn.closest('tr').remove();
                                    updateCost();
                                }

                                function toggleEdit() {
                                    const btn = document.getElementById('btnConfirm');
                                    const btnAdd = document.getElementById('btnAddRow');
                                    const tbody = document.getElementById('items-body');
                                    const inputs = tbody.querySelectorAll('input');
                                    const removeBtns = tbody.querySelectorAll('.btn-danger');

                                    if (!isLocked) {
                                        // LOCK and SERIALIZE
                                        if (tbody.children.length === 0) {
                                            alert("Adicione pelo menos um item para confirmar.");
                                            return;
                                        }

                                        let data = "ID;Descricao;valor_venda;quantidade\n";
                                        const rows = tbody.querySelectorAll('tr');

                                        for(let i=0; i<rows.length; i++) {
                                            const rowInputs = rows[i].querySelectorAll('input');
                                            if (rowInputs.length >= 3) {
                                                const desc = rowInputs[0].value.replace(/;/g, ',').trim() || 'Item Sem Nome';
                                                const price = rowInputs[1].value || '0';
                                                const qty = rowInputs[2].value || '1';
                                                data += `${i + 1};${desc};${price};${qty}\n`;
                                            }
                                        }

                                        document.getElementById('gridData').value = data;

                                        // UI Updates
                                        inputs.forEach(inp => inp.disabled = true);
                                        removeBtns.forEach(b => b.disabled = true);
                                        btnAdd.disabled = true;
                                        btn.innerHTML = '<i class="fas fa-edit"></i> Editar Itens';
                                        btn.className = 'btn btn-sm btn-warning';
                                        isLocked = true;

                                        // Enable Submit (if it was blocked logic, but we handle that in updateCost)

                                    } else {
                                        // UNLOCK
                                        inputs.forEach(inp => inp.disabled = false);
                                        removeBtns.forEach(b => b.disabled = false);
                                        btnAdd.disabled = false;
                                        btn.innerHTML = '<i class="fas fa-check"></i> Confirmar Itens';
                                        btn.className = 'btn btn-sm btn-primary';

                                        document.getElementById('gridData').value = ""; // Clear to force re-confirm
                                        isLocked = false;
                                    }
                                }

                                function updateCost() {
                                    const rows = document.querySelectorAll('#items-body tr').length;
                                    document.getElementById('estimated-cost').innerText = rows;
                                    const btn = document.querySelector('button[type="submit"]');

                                    if (!isAdmin && rows > userCredits) {
                                        btn.disabled = true;
                                        btn.innerText = `Saldo Insuficiente (Faltam ${rows - userCredits})`;
                                    } else if (rows === 0) {
                                        const fileInput = document.getElementById('fallbackCsv');
                                        if (!fileInput.value) {
                                             btn.innerText = 'Adicione Itens ou CSV';
                                        }
                                    } else {
                                        btn.disabled = false;
                                        btn.innerText = 'üöÄ Decolar (Iniciar)';
                                    }
                                }

                                // Initial Row
                                addRow();

                                // AI TR Upload Logic
                                async function uploadTR(input) {
                                    if (input.files.length === 0) return;
                                    const formData = new FormData();

                                    // Handle multiple files
                                    for (let i = 0; i < input.files.length; i++) {
                                        formData.append('pdfFiles', input.files[i]);
                                    }

                                    const statusSpan = document.getElementById('ai-status');
                                    statusSpan.innerText = '‚è≥ Analisando documentos com I.A...';

                                    try {
                                        const res = await fetch('/api/process-tr', {
                                            method: 'POST',
                                            body: formData
                                        });
                                        const data = await res.json();

                                        if (data.success) {
                                            // 1. Fill Global Info
                                            if (data.global_info) {
                                                if (data.global_info.name) document.getElementById('taskName').value = data.global_info.name;
                                                if (data.global_info.cep) document.getElementById('taskCep').value = data.global_info.cep;
                                            }

                                            // 2. Store Metadata
                                            if (data.metadata) {
                                                document.getElementById('metadataJSON').value = JSON.stringify(data.metadata);
                                            }

                                            // 3. Fill Items
                                            if (data.items && data.items.length > 0) {
                                                statusSpan.innerText = `‚úÖ Processamento completo! ${data.items.length} itens encontrados.`;
                                                populateGrid(data.items);
                                            } else {
                                                statusSpan.innerText = '‚ö†Ô∏è Processado, mas nenhum item foi identificado na lista.';
                                            }
                                        } else {
                                            statusSpan.innerText = `‚ùå Erro: ${data.error || 'Falha desconhecida'}`;
                                        }
                                    } catch (e) {
                                        statusSpan.innerText = `‚ùå Erro de conex√£o: ${e.message}`;
                                    }
                                    input.value = ''; // Reset
                                }

                                function populateGrid(items) {
                                    const tbody = document.getElementById('items-body');
                                    tbody.innerHTML = ''; // Clear existing
                                    rowCount = 0;

                                    // Unlock if locked to allow population
                                    if (isLocked) toggleEdit();

                                    items.forEach(item => {
                                        rowCount++;
                                        const tr = document.createElement('tr');
                                        tr.innerHTML = `
                                            <td>${rowCount}</td>
                                            <td><input type="text" class="form-control form-control-sm" value="${item.description}" required></td>
                                            <td><input type="number" step="0.01" class="form-control form-control-sm" value="${item.valor_venda}" required></td>
                                            <td><input type="number" class="form-control form-control-sm" value="${item.quantidade}" required></td>
                                            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">X</button></td>
                                        `;
                                        tbody.appendChild(tr);
                                    });
                                    updateCost();
                                }

                                // Form Submit Interceptor
                                document.querySelector('form').addEventListener('submit', function(e) {
                                    const gridData = document.getElementById('gridData').value;
                                    const fileInput = document.getElementById('fallbackCsv');
                                    const itemsCount = document.querySelectorAll('#items-body tr').length;

                                    // If we have items but data is empty (user didn't click Confirm), force confirm or alert
                                    if (itemsCount > 0 && (!gridData || gridData.trim().length === 0)) {
                                        // Attempt auto-confirm?
                                        // User asked to "force confirm". Better to block and ask to confirm.
                                        e.preventDefault();
                                        alert("Por favor, clique em 'Confirmar Itens' antes de enviar a tarefa.");
                                        // Highlight button?
                                        document.getElementById('btnConfirm').focus();
                                        return false;
                                    }
                                });
                            </script>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">üöÄ Decolar (Iniciar)</button>
                        <a href="/" class="btn btn-outline-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>
