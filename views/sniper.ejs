<%- include('partials/header') %>

<!-- No custom style block needed, using Tailwind -->

<div class="mb-8 text-center mt-6">
    <h2 class="text-3xl font-bold text-base-content">COTADOR AUTOMÁTICO</h2>
    <p class="text-base-content/60">Importação Inteligente de Editais</p>
</div>

<!-- UPLOAD ZONE -->
<div id="uploadContainer" class="flex flex-col items-center justify-center min-h-[50vh] gap-6">
    <!-- Tabs -->
    <div role="tablist" class="tabs tabs-boxed mb-4">
        <a role="tab" class="tab tab-active" id="tabPdf" onclick="switchTab('pdf')">Arquivo PDF</a>
        <a role="tab" class="tab" id="tabManual" onclick="switchTab('manual')">Inserção Manual</a>
    </div>

    <!-- PDF Content -->
    <div id="contentPdf" class="w-full flex flex-col items-center gap-6">
        <label for="pdfFiles" class="w-full max-w-4xl h-80 border-2 border-dashed border-base-300 rounded-2xl flex flex-col justify-center items-center cursor-pointer hover:border-primary hover:bg-base-200 transition-all bg-base-100 shadow-sm relative group" id="dropZoneArea">
            <i class="fas fa-file-pdf fa-4x text-primary mb-4 group-hover:scale-110 transition-transform"></i>
            <div class="text-xl font-bold text-primary drop-zone-text">ARRASTE O EDITAL AQUI</div>
            <div class="text-sm text-base-content/60 mt-2">A I.A. irá ler e preencher tudo automaticamente</div>
            <input type="file" id="pdfFiles" accept=".pdf" multiple hidden onchange="showProcessButton()">
        </label>

        <div class="w-full max-w-4xl">
            <label class="label">
                <span class="label-text text-xs font-bold uppercase opacity-60"><i class="fas fa-robot"></i> Instruções Especiais para a I.A. (Opcional)</span>
            </label>
            <textarea id="aiInstructions" class="textarea textarea-bordered w-full h-24" placeholder="Ex: Cotar apenas itens de informática. Ignorar serviços."></textarea>
        </div>

        <button id="btnProcessPdf" class="btn btn-success btn-lg w-full max-w-2xl hidden shadow-lg text-white" onclick="handlePdfUpload()">
            <i class="fas fa-microchip"></i> PROCESSAR EDITAL AGORA
        </button>
    </div>

    <!-- Manual Content -->
    <div id="contentManual" class="w-full flex flex-col items-center gap-6 hidden">
        <div class="w-full max-w-4xl">
            <label class="label">
                <span class="label-text text-xs font-bold uppercase opacity-60">COLE OS DADOS (CSV: ID;Descrição;Valor;Qtd)</span>
            </label>
            <textarea id="manualCsvInput" class="textarea textarea-bordered w-full h-80 font-mono text-xs" placeholder="1;Notebook Dell;3500.00;2&#10;2;Mouse USB;50.00;10&#10;3;Teclado ABNT2;80.00;5"></textarea>
            <div class="text-xs text-base-content/60 mt-2">
                * O separador deve ser ponto-e-vírgula (;)<br>
                * A ordem das colunas é: ID; Descrição; Valor Máximo; Quantidade
            </div>
        </div>
        <button class="btn btn-success btn-lg w-full max-w-2xl text-white shadow-lg" onclick="handleManualCsv()">
            <i class="fas fa-table"></i> PROCESSAR CSV
        </button>
    </div>
</div>

<!-- RECENT TASKS -->
<div class="mt-12 mb-8">
    <div class="container mx-auto max-w-5xl">
        <h4 class="text-xs font-bold uppercase opacity-60 mb-4 ml-1"><i class="fas fa-history"></i> MISSÕES RECENTES</h4>
        <div class="grid grid-cols-1 gap-4">
             <%- include('partials/task_list', { tasks: recentTasks }) %>
        </div>
    </div>
</div>

<!-- FORM CONTAINER (Results) -->
<div class="flex justify-center hidden pb-12" id="sniperFormContainer">
    <div class="w-full max-w-6xl">
        <div class="card bg-base-100 shadow-xl border border-base-200">
            <div class="card-body p-6">

                <form action="/create" method="POST" enctype="multipart/form-data" id="sniperForm">
                    <!-- HIDDEN DATA FIELDS -->
                    <input type="hidden" name="metadataJSON" id="metadataJSON">
                    <input type="hidden" name="gridData" id="gridData">

                    <!-- TOP CONFIG -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="md:col-span-2">
                            <label class="label">
                                <span class="label-text text-xs font-bold uppercase opacity-60">NOME DA MISSÃO</span>
                            </label>
                            <input type="text" name="name" id="taskName" class="input input-bordered w-full" required placeholder="Ex: Município - Pregão 42/2025">
                        </div>
                        <div>
                            <label class="label">
                                <span class="label-text text-xs font-bold uppercase opacity-60">CEP DESTINO</span>
                            </label>
                            <input type="text" name="cep" id="taskCep" class="input input-bordered w-full" required placeholder="00000-000">
                        </div>
                    </div>

                    <% if (userGroups && userGroups.length > 0) { %>
                    <div class="mb-6">
                         <label class="label">
                            <span class="label-text text-xs font-bold uppercase opacity-60">VISIBILIDADE (GRUPO)</span>
                        </label>
                        <select name="group_id" class="select select-bordered w-full">
                            <option value="">PRIVADO (APENAS EU)</option>
                            <% userGroups.forEach(function(group) { %>
                                <option value="<%= group.id %>"><%= group.name %></option>
                            <% }); %>
                        </select>
                    </div>
                    <% } %>

                    <!-- ITEM LIST AREA -->
                    <div class="card bg-base-200 border border-base-300 mb-6 rounded-box overflow-hidden">
                        <div class="p-4 bg-base-200 flex justify-between items-center border-b border-base-300">
                            <span class="text-primary font-bold flex items-center gap-2"><i class="fas fa-list"></i> ITENS IDENTIFICADOS</span>
                            <div class="badge badge-lg bg-base-100 border border-base-300 shadow-sm" id="item-count">0 ITENS</div>
                        </div>
                        <div class="overflow-x-auto max-h-[500px]">
                            <table class="table table-pin-rows w-full bg-base-100">
                                <thead>
                                    <tr class="text-xs uppercase opacity-60 bg-base-200 text-base-content">
                                        <th class="w-12">#</th>
                                        <th>DESCRIÇÃO</th>
                                        <th class="w-40">MAX (R$)</th>
                                        <th class="w-24">QTD</th>
                                        <th class="w-12"></th>
                                    </tr>
                                </thead>
                                <tbody id="items-body">
                                    <!-- Items go here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 bg-base-200 border-t border-base-300 flex justify-between flex-wrap gap-2">
                            <button type="button" class="btn btn-sm btn-ghost border-base-300 bg-base-100" onclick="addRow()">
                                <i class="fas fa-plus"></i> ADICIONAR MANUALMENTE
                            </button>
                            <div class="flex items-center gap-2">
                                <label class="btn btn-sm btn-ghost border-base-300 bg-base-100" title="Importar CSV Simples">
                                    <i class="fas fa-file-csv"></i> IMPORTAR CSV
                                    <input type="file" name="csvFile" hidden onchange="alert('CSV selecionado!')">
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ACTION -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <button type="button" class="btn btn-outline btn-error" onclick="resetUpload()">
                            <i class="fas fa-undo"></i> CANCELAR
                        </button>
                        <button type="submit" class="btn btn-success text-white shadow-md" id="btnStart">
                            <i class="fas fa-rocket"></i> INICIAR COTAÇÃO AUTOMÁTICA
                        </button>
                    </div>

                </form>

            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-base-100/80 backdrop-blur-sm z-[9999] hidden flex-col justify-center items-center">
    <span class="loading loading-spinner loading-lg text-primary mb-4"></span>
    <div class="text-xl font-bold text-primary">PROCESSANDO EDITAL...</div>
    <div class="text-sm opacity-60">Extraindo itens e metadados com I.A.</div>
</div>

<script>
    let rowCount = 0;
    const dropZone = document.getElementById('dropZoneArea');
    const uploadContainer = document.getElementById('uploadContainer');
    const formContainer = document.getElementById('sniperFormContainer');
    const loadingOverlay = document.getElementById('loadingOverlay');

    function switchTab(tabName) {
        document.getElementById('tabPdf').classList.remove('tab-active');
        document.getElementById('tabManual').classList.remove('tab-active');
        document.getElementById('contentPdf').classList.add('hidden');
        document.getElementById('contentManual').classList.add('hidden');

        if (tabName === 'pdf') {
            document.getElementById('tabPdf').classList.add('tab-active');
            document.getElementById('contentPdf').classList.remove('hidden');
        } else {
            document.getElementById('tabManual').classList.add('tab-active');
            document.getElementById('contentManual').classList.remove('hidden');
        }
    }

    function handleManualCsv() {
        const csvText = document.getElementById('manualCsvInput').value;
        if (!csvText.trim()) {
            alert('Cole o conteúdo CSV primeiro.');
            return;
        }

        const lines = csvText.split('\n');
        const items = [];
        let validLines = 0;

        // Skip header if looks like header
        const startIdx = (lines[0].toLowerCase().includes('descricao') || lines[0].toLowerCase().includes('descrição')) ? 1 : 0;

        for (let i = startIdx; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // Handle simple semicolon split (no quote escaping support for now as per instructions "simple csv")
            const parts = line.split(';');
            if (parts.length >= 2) { // Allow loose format if ID missing, but instruction says ID;Desc;Val;Qtd
                // Try to map correctly
                // Format: ID;Descricao;valor_venda;quantidade
                let id = parts[0] || (i + 1);
                let desc = parts[1] || "Item sem descrição";
                let val = parts[2] ? parts[2].replace(',', '.') : 0; // Fix comma decimal
                let qtd = parts[3] ? parts[3].replace(',', '.') : 1;

                // Basic cleanup
                desc = desc.replace(/"/g, '').trim();

                items.push({
                    id: id,
                    description: desc,
                    valor_venda: parseFloat(val) || 0,
                    quantidade: parseInt(qtd) || 1
                });
                validLines++;
            }
        }

        if (validLines === 0) {
            alert('Nenhum item válido encontrado. Verifique o formato: ID;Descrição;Valor;Qtd (separado por ponto e vírgula)');
            return;
        }

        // Reset UI
        uploadContainer.style.display = 'none';
        formContainer.classList.remove('hidden');
        formContainer.style.display = 'flex';

        populateGrid(items);
        alert(`${validLines} itens importados com sucesso!`);
    }

    // Drag & Drop
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault(); e.stopPropagation();
            dropZone.classList.add('border-primary', 'bg-base-200');
        }, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault(); e.stopPropagation();
            dropZone.classList.remove('border-primary', 'bg-base-200');
        }, false);
    });

    dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        document.getElementById('pdfFiles').files = files;
        showProcessButton();
    });

    function showProcessButton() {
        const input = document.getElementById('pdfFiles');
        if (input.files.length > 0) {
            document.getElementById('btnProcessPdf').classList.remove('hidden');
            document.querySelector('.drop-zone-text').innerText = `${input.files.length} ARQUIVO(S) SELECIONADO(S)`;
        }
    }

    async function handlePdfUpload() {
        const input = document.getElementById('pdfFiles');
        const instructions = document.getElementById('aiInstructions').value;

        if (input.files.length === 0) return;

        // Show Loading
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.style.display = 'flex';

        const formData = new FormData();
        for (let i = 0; i < input.files.length; i++) {
            formData.append('pdfFiles', input.files[i]);
        }

        // Append Instructions
        if (instructions) {
            formData.append('instructions', instructions);
        }

        try {
            const res = await fetch('/api/sniper/parse-pdf', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.error) throw new Error(data.error);

            // Hide Upload, Show Form
            uploadContainer.style.display = 'none';
            formContainer.classList.remove('hidden');
            formContainer.style.display = 'flex';

            // Fill Data
            if (data.metadata) {
                if (data.metadata.name) document.getElementById('taskName').value = data.metadata.name;
                if (data.metadata.cep) document.getElementById('taskCep').value = data.metadata.cep;
            }

            if (data.items && data.items.length > 0) {
                populateGrid(data.items);
            } else {
                addRow(); // Add empty row if none
                alert("Nenhum item detectado automaticamente. Preencha manualmente.");
            }

        } catch (e) {
            console.error(e);
            alert("Erro na leitura do PDF: " + e.message);
            loadingOverlay.classList.add('hidden');
             loadingOverlay.style.display = 'none';
        } finally {
            loadingOverlay.classList.add('hidden');
             loadingOverlay.style.display = 'none';
            input.value = '';
        }
    }

    function resetUpload() {
        formContainer.classList.add('hidden');
         formContainer.style.display = 'none';

        uploadContainer.style.display = 'flex';

        document.getElementById('items-body').innerHTML = '';
        document.getElementById('taskName').value = '';
        document.getElementById('taskCep').value = '';
        document.getElementById('aiInstructions').value = '';
        document.getElementById('btnProcessPdf').classList.add('hidden');

        document.querySelector('.drop-zone-text').innerText = 'ARRASTE O EDITAL AQUI';
    }

    function addRow(item = {}) {
        rowCount++;
        const tbody = document.getElementById('items-body');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="text-base-content/60 font-mono text-xs">${rowCount}</td>
            <td><input type="text" class="input input-ghost input-sm w-full focus:bg-base-100" value="${item.description || ''}" placeholder="Item..." required></td>
            <td><input type="number" step="0.01" class="input input-ghost input-sm w-full focus:bg-base-100" value="${item.valor_venda || ''}" placeholder="0.00" required></td>
            <td><input type="number" class="input input-ghost input-sm w-full focus:bg-base-100" value="${item.quantidade || 1}" required></td>
            <td><button type="button" class="btn btn-ghost btn-xs text-error" onclick="this.closest('tr').remove(); updateCount();"><i class="fas fa-times"></i></button></td>
        `;
        tbody.appendChild(tr);
        updateCount();
    }

    function populateGrid(items) {
        document.getElementById('items-body').innerHTML = '';
        rowCount = 0;
        items.forEach(item => addRow(item));
    }

    function updateCount() {
        const count = document.getElementById('items-body').children.length;
        document.getElementById('item-count').innerText = `${count} ITENS`;
    }

    // Form Interceptor to Serialize Grid
    document.getElementById('sniperForm').addEventListener('submit', (e) => {
        let data = "ID;Descricao;valor_venda;quantidade\n";
        const rows = document.querySelectorAll('#items-body tr');
        let validRows = 0;

        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input');
            const desc = inputs[0].value.replace(/;/g, ' ').trim();
            const price = inputs[1].value || 0;
            const qty = inputs[2].value || 1;

            if (desc) {
                data += `${index + 1};${desc};${price};${qty}\n`;
                validRows++;
            }
        });

        if (validRows === 0) {
            e.preventDefault();
            alert("Adicione pelo menos um item!");
            return false;
        }

        document.getElementById('gridData').value = data;
    });

</script>

<%- include('partials/footer') %>
