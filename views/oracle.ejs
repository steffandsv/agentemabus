<%- include('partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- No custom styles block needed -->

<div class="container mx-auto px-4 pb-20">
    <!-- Header Title -->
    <div class="text-center my-12 section">
        <h1 class="text-5xl font-black text-base-content tracking-tight mb-2">ANALISADOR ESTRATÃ‰GICO</h1>
        <p class="text-base-content/60 text-lg">AnÃ¡lise Profunda de Editais</p>
    </div>

    <!-- UPLOAD ZONE -->
    <div id="uploadContainer" class="flex justify-center items-center min-h-[60vh] section">
        <form id="uploadForm" class="w-full max-w-4xl">
            <label for="pdfFiles" class="w-full h-96 border-2 border-dashed border-base-300 rounded-3xl flex flex-col justify-center items-center cursor-pointer hover:border-primary hover:bg-base-200 transition-all bg-base-100 shadow-xl relative group" id="dropZoneArea">
                <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-6 group-hover:scale-110 transition-transform"></i>
                <div class="text-2xl font-bold text-primary drop-zone-text">ARRASTE SEU EDITAL (PDF)</div>
                <div class="text-base-content/60 mt-2">AnÃ¡lise automÃ¡tica de riscos e oportunidades</div>
                <input type="file" id="pdfFiles" name="pdfFiles" accept=".pdf" multiple hidden required>
            </label>
        </form>
    </div>

    <!-- LOADER -->
    <div id="loader" class="hidden text-center py-20">
        <div class="w-24 h-24 bg-primary rounded-full animate-ping mx-auto mb-8 opacity-20"></div>
        <div class="text-xl font-bold text-base-content">Analisando documentos com InteligÃªncia Artificial...</div>
        <div class="text-base-content/60 mt-2">Isso pode levar alguns minutos.</div>
    </div>

    <!-- RESULT CONTAINER -->
    <div id="resultContainer" class="hidden max-w-6xl mx-auto">
        <!-- HEADER / TEASER -->
        <div class="text-center mb-12 section">
            <div id="ipmDisplay" class="text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary mb-4">0</div>
            <div id="classificacaoDisplay" class="text-2xl font-bold tracking-widest mb-4">---</div>
            <div id="tagsDisplay" class="flex flex-wrap justify-center gap-2 mb-6"></div>
            <p id="resumoDisplay" class="text-xl text-base-content/70 italic max-w-3xl mx-auto">"..."</p>
        </div>

        <!-- MODULES GRID -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 section" id="modulesGrid">
            <!-- Dynamic Cards Will Be Injected Here -->
        </div>

        <!-- SNIPER ACTION -->
        <div class="mt-12 section text-center">
             <form action="/create" method="POST" id="sniperForm">
                <input type="hidden" name="name" id="sniperName">
                <input type="hidden" name="cep" value="00000-000">
                <input type="hidden" name="gridData" id="sniperGridData">
                <input type="hidden" name="metadataJSON" id="sniperMetadata">
                <input type="hidden" name="moduleName" value="gemini_meli">
                <input type="hidden" name="existingFilePath" id="sniperExistingFilePath">

                <button type="submit" class="btn btn-success btn-lg rounded-full px-8 shadow-lg text-white hover:scale-105 transition-transform">
                    <i class="fas fa-bullseye mr-2"></i> IMPORTAR ITENS PARA O COTADOR
                </button>
            </form>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    const dropZone = document.getElementById('dropZoneArea');
    const fileInput = document.getElementById('pdfFiles');
    const uploadForm = document.getElementById('uploadForm');
    const uploadContainer = document.getElementById('uploadContainer');
    const resultContainer = document.getElementById('resultContainer');
    const loader = document.getElementById('loader');

    // Drag & Drop UI (Tailwind based)
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-primary', 'bg-base-200');
        }, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-primary', 'bg-base-200');
        }, false);
    });
    dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        fileInput.files = files;
        handleUpload();
    });
    fileInput.addEventListener('change', handleUpload);

    async function handleUpload() {
        if (fileInput.files.length === 0) return;

        // Toggle UI
        uploadContainer.style.display = 'none';
        loader.style.display = 'block';
        loader.classList.remove('hidden');

        const formData = new FormData(uploadForm);

        try {
            const response = await fetch('/api/process-tr', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error(`Erro: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });

                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            if (json && json.metadata) {
                                renderResult(json);
                            }
                        } catch(e) {}
                    }
                }
            }

            // Finish
            loader.style.display = 'none';
            loader.classList.add('hidden');

            resultContainer.style.display = 'block';
            resultContainer.classList.remove('hidden');

        } catch (error) {
            console.error(error);
            alert("Erro ao processar: " + error.message);
            loader.style.display = 'none';
            uploadContainer.style.display = 'flex';
        }
    }

    function renderResult(data) {
        const meta = data.metadata || {};
        const locked = data.locked_content || {};

        // 1. Header (Teaser)
        const score = meta.ipm_score || 0;

        const ipmEl = document.getElementById('ipmDisplay');
        ipmEl.innerText = score;

        const classDisplay = document.getElementById('classificacaoDisplay');
        classDisplay.innerText = meta.classificacao || 'ANÃLISE CONCLUÃDA';

        document.getElementById('resumoDisplay').innerText = `"${meta.resumo_glitch || meta.resumo_poderoso || '...'}"`;

        const tagsContainer = document.getElementById('tagsDisplay');
        tagsContainer.innerHTML = '';
        const tags = meta.tags_visuais || meta.tags_elite || [];
        tags.forEach(tag => {
            tagsContainer.innerHTML += `<span class="badge badge-primary badge-outline font-bold p-3">${tag}</span>`;
        });

        // 2. Modules (Atomic Widgets)
        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = '';

        const createWidget = (key, moduleData) => {
            if (!moduleData) return;
            const title = moduleData.titulo || key.toUpperCase();
            const cost = moduleData.custo_watts || 100;
            const cardId = `module-${key}`;

            let contentHtml = '';

            // WIDGET LOGIC
            if (moduleData.taticas && Array.isArray(moduleData.taticas)) {
                contentHtml = moduleData.taticas.map(t => `
                    <div class="bg-base-200 border-l-4 border-primary p-4 mb-2 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">${t.icone || 'ðŸ”¹'}</span>
                            <div>
                                <div class="font-bold text-base-content">${t.titulo}</div>
                                <small class="text-base-content/70">${marked.parseInline(t.texto || '')}</small>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            else if (moduleData.dados && Array.isArray(moduleData.dados)) {
                contentHtml = '<table class="table table-zebra w-full text-sm"><tbody>';
                contentHtml += moduleData.dados.map(d => `
                    <tr>
                        <td class="font-medium text-base-content/70">${d.label}</td>
                        <td class="text-right font-mono font-bold ${d.alerta === 'ALTO RISCO' ? 'text-error' : 'text-base-content'}">${d.valor}</td>
                    </tr>
                `).join('');
                contentHtml += '</tbody></table>';
            }
            else if (moduleData.lista_riscos && Array.isArray(moduleData.lista_riscos)) {
                contentHtml = moduleData.lista_riscos.map(r => `
                    <div class="flex items-center gap-2 text-error bg-error/10 p-2 rounded mb-2 font-medium"><i class="fas fa-exclamation-triangle"></i> ${marked.parseInline(r)}</div>
                `).join('');
            }
            else if (moduleData.conteudo_oculto) {
                 const text = Array.isArray(moduleData.conteudo_oculto)
                    ? moduleData.conteudo_oculto.map(i => `â€¢ ${i.item || i}: ${i.motivo || ''}`).join('<br>')
                    : moduleData.conteudo_oculto;
                 contentHtml = marked.parse(text);
            }

            const html = `
                <div class="card bg-base-100 shadow-xl border border-base-200 h-full transform transition hover:-translate-y-1 hover:shadow-2xl" id="${cardId}">
                    <div class="card-body p-0">
                        <div class="p-4 border-b border-base-200 flex justify-between items-center bg-base-100 rounded-t-2xl">
                            <span class="font-bold font-title text-lg">${title}</span>
                            <div class="badge badge-warning gap-1"><i class="fas fa-bolt"></i> ${cost}</div>
                        </div>
                        <div class="p-6 relative min-h-[150px]">
                            <div class="blur-md select-none transition-all duration-500" id="blur-${key}">
                                ${contentHtml}
                            </div>
                            <div class="absolute inset-0 flex justify-center items-center bg-base-100/10 backdrop-blur-[2px]" id="overlay-${key}">
                                <button class="btn btn-warning shadow-lg rounded-full px-6" onclick="unlockModule('${key}', ${cost})">
                                    <i class="fas fa-lock-open mr-2"></i> DESBLOQUEAR
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            grid.innerHTML += html;
        };

        if (locked.estrategia_vitoria) createWidget('estrategia_vitoria', locked.estrategia_vitoria);
        if (locked.analise_financeira) createWidget('analise_financeira', locked.analise_financeira);
        if (locked.armadilhas_juridicas) createWidget('armadilhas_juridicas', locked.armadilhas_juridicas);
        if (!locked.estrategia_vitoria && locked.analise_risco_financeiro) createWidget('analise_risco_financeiro', locked.analise_risco_financeiro);

        // 3. Sniper Form Setup
        document.getElementById('sniperName').value = meta.edital_numero || 'Oracle Mission';
        document.getElementById('sniperMetadata').value = JSON.stringify(meta);

        if (data.file_path) {
            document.getElementById('sniperExistingFilePath').value = data.file_path;
        }

        document.getElementById('sniperGridData').value = "ID;Descricao;valor_venda;quantidade\n";
    }

    window.unlockModule = function(key, cost) {
        const blur = document.getElementById(`blur-${key}`);
        const overlay = document.getElementById(`overlay-${key}`);
        if (blur) blur.classList.remove('blur-md', 'select-none');
        if (overlay) {
            overlay.style.display = 'none';
        }
    };
</script>
