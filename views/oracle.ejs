<%- include('partials/header') %>

<div class="row mb-4">
    <div class="col-12 text-center">
        <h2 class="brand-font text-gold">游댩 OR츼CULO T츼TICO</h2>
        <p class="text-muted">An치lise Preditiva de Editais</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- DRAG & DROP ZONE -->
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('trFile').click()">
            <input type="file" id="trFile" accept=".pdf" style="display: none;" multiple onchange="handleFiles(this.files)">
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <h4 class="text-main">ARRASTE SEU EDITAL AQUI</h4>
            <p class="text-muted small">Para a vidente analisar</p>
        </div>

        <!-- MATRIX TERMINAL (LOADING) -->
        <div class="matrix-terminal mt-4 rounded" id="terminal">
            <div id="terminal-content"></div>
        </div>

        <!-- RESULT CARD (HIDDEN) -->
        <div id="oracle-result" class="card card-gold mt-5" style="display:none;">
            <div class="card-header bg-transparent border-warning d-flex justify-content-between align-items-center">
                <h4 class="mb-0 text-warning" id="oracle-title">RELAT칍RIO T츼TICO</h4>
                <span class="badge bg-warning text-dark fs-5" id="oracle-score">IPM: 00</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5 border-end border-secondary">
                        <h5 class="text-muted small uppercase">METADATA</h5>
                        <p id="oracle-teaser" class="fs-5 text-white">...</p>
                        <div id="oracle-tags" class="mb-3"></div>
                        <h3 class="text-warning" id="oracle-profit">R$ 0,00</h3>
                        <p class="text-muted small">Potencial Estimado</p>
                    </div>
                    <div class="col-md-7">
                        <h5 class="text-muted small uppercase">ESTRAT칄GIA</h5>
                        <div id="strategy-content" class="text-white small" style="white-space: pre-wrap;">
                            <!-- Markdown injected here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-warning text-end">
                <button class="btn btn-primary btn-lg shadow-blue" onclick="sendToSniper()">
                    <i class="fas fa-crosshairs"></i> ENVIAR PARA SNIPER
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const terminal = document.getElementById('terminal');
    const termContent = document.getElementById('terminal-content');

    let oracleData = null;

    // Drag & Drop Events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        if (files.length === 0) return;

        // UI Transition
        dropZone.style.display = 'none';
        terminal.style.display = 'block';

        // Matrix Animation
        const logs = [
            "Inicializando n칰cleo de processamento...",
            "Lendo estrutura PDF...",
            "Extraindo objetos e quantidades...",
            "Cruzando dados com IPM v3.0...",
            "Calculando viabilidade econ칪mica...",
            "Detectando armadilhas jur칤dicas...",
            "Gerando relat칩rio t치tico..."
        ];

        let i = 0;
        termContent.innerHTML = '';
        const interval = setInterval(() => {
            if (i < logs.length) {
                const line = document.createElement('div');
                line.className = 'terminal-line';
                line.innerText = `> ${logs[i]}`;
                termContent.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
                i++;
            }
        }, 800);

        // Upload
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('pdfFiles', files[i]);
        }

        fetch('/api/process-tr', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                clearInterval(interval);
                if (data.success) {
                    oracleData = data;
                    renderResult(data);
                } else {
                    termContent.innerHTML += `<div class="text-danger">> ERRO: ${data.error}</div>`;
                }
            })
            .catch(e => {
                clearInterval(interval);
                termContent.innerHTML += `<div class="text-danger">> FALHA DE CONEX츾O: ${e.message}</div>`;
            });
    }

    function renderResult(data) {
        terminal.style.display = 'none';
        const card = document.getElementById('oracle-result');
        const m = data.metadata || {};
        const locked = m.locked_content || {};

        document.getElementById('oracle-title').innerText = m.titulo_resumo || "AN츼LISE CONCLU칈DA";
        document.getElementById('oracle-score').innerText = `IPM: ${m.ipm_score || 0}`;
        document.getElementById('oracle-teaser').innerText = m.resumo_teaser || "Sem resumo.";
        document.getElementById('oracle-profit').innerText = m.potencial_lucro_estimado || "???";

        // Tags
        const tagsContainer = document.getElementById('oracle-tags');
        tagsContainer.innerHTML = '';
        if (m.tags_gatilho) {
            m.tags_gatilho.forEach(tag => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-dark border border-secondary me-1 text-muted';
                badge.innerText = tag;
                tagsContainer.appendChild(badge);
            });
        }

        // Strategy (Unlocked for simplicity in this flow, or kept "locked" until clicked)
        // The user said: "Aparece o 'Relat칩rio T치tico'... Clica num bot칚o: [ENVIAR PARA SNIPER]"
        // We will show the report.
        document.getElementById('strategy-content').innerText = locked.analise_completa_markdown || "Sem dados estrat칠gicos.";

        card.style.display = 'block';
    }

    function sendToSniper() {
        if (!oracleData) return;
        // Save to sessionStorage to pass to Sniper
        sessionStorage.setItem('oracleData', JSON.stringify(oracleData));
        window.location.href = '/sniper';
    }
</script>

<%- include('partials/footer') %>
