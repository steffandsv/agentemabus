<!--
    NOTE: header partial contains <header> etc. but NOT <html> tags,
    however default layout usage suggests we should be careful.
    The header partial provided earlier seems to have <header> but assumes standard bootstrap structure.
    Wait, the user's `header.ejs` content I read earlier has `<!DOCTYPE html><html>...`
    So I must NOT duplicate it.
-->
<%- include('partials/header') %>

<!-- Custom Style override for this page -->
<style>
    :root {
        --neon-blue: #00f3ff;
        --neon-green: #0aff00;
        --neon-gold: #ffd700;
        --dark-bg: #050505;
        --card-bg: #111;
        --border-color: #333;
    }
    /* Only apply body background if not handled by header style */
    body {
        background-color: var(--dark-bg);
    }

    .card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        color: #fff;
    }
    .btn-neon {
        background-color: transparent;
        border: 1px solid var(--neon-blue);
        color: var(--neon-blue);
        transition: all 0.3s;
    }
    .btn-neon:hover {
        background-color: var(--neon-blue);
        color: #000;
        box-shadow: 0 0 10px var(--neon-blue);
    }

    /* Loading Overlay */
    #loadingOverlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 9999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    .scanner-line {
        width: 100%;
        height: 2px;
        background: var(--neon-blue);
        box-shadow: 0 0 10px var(--neon-blue);
        animation: scan 2s infinite linear;
        margin-bottom: 20px;
    }
    @keyframes scan {
        0% { transform: scaleX(0); opacity: 0; }
        50% { transform: scaleX(1); opacity: 1; }
        100% { transform: scaleX(0); opacity: 0; }
    }

    #currentThoughtTitle {
        font-size: 1.5rem;
        color: var(--neon-blue);
        text-transform: uppercase;
        letter-spacing: 2px;
        animation: pulse 1.5s infinite;
        margin-top: 20px;
    }
    @keyframes pulse {
        0% { opacity: 0.6; text-shadow: 0 0 5px var(--neon-blue); }
        50% { opacity: 1; text-shadow: 0 0 20px var(--neon-blue); }
        100% { opacity: 0.6; text-shadow: 0 0 5px var(--neon-blue); }
    }

    /* Result Styles */
    .result-header {
        border-bottom: 1px solid #333;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }
    .metric-box {
        background: #1a1a1a;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        border: 1px solid #333;
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--neon-gold);
    }
    .metric-label {
        font-size: 0.8rem;
        color: #aaa;
        text-transform: uppercase;
    }

    .tag-badge {
        background: #222;
        border: 1px solid var(--neon-blue);
        color: var(--neon-blue);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        margin-right: 5px;
        margin-bottom: 5px;
        display: inline-block;
    }

    .section-title {
        color: var(--neon-green);
        font-weight: bold;
        margin-top: 20px;
        margin-bottom: 10px;
        border-left: 3px solid var(--neon-green);
        padding-left: 10px;
    }

    .risk-item {
        color: #ff4444;
        padding: 5px 0;
    }
    .highlight-item {
        color: var(--neon-gold);
        padding: 5px 0;
    }

    .history-card {
        cursor: pointer;
        transition: transform 0.2s;
    }
    .history-card:hover {
        transform: translateY(-5px);
        border-color: var(--neon-blue);
    }

    /* Hide generic thoughts */
    #aiThoughts {
        display: none !important;
    }
</style>

<div class="container mt-5">
    <h2 class="mb-4 text-center"><i class="fas fa-eye text-info"></i> Oráculo de Licitações</h2>

    <div class="card p-4 mb-4">
        <h5 class="card-title">Upload de Edital (PDF)</h5>
        <p class="text-muted">A I.A. fará uma leitura completa e calculará o IPM (Índice de Potencial de Mercado).</p>
        <form id="uploadForm">
            <div class="mb-3">
                <input class="form-control bg-dark text-light" type="file" id="pdfFiles" name="pdfFiles" accept=".pdf" multiple required>
            </div>
            <button type="submit" class="btn btn-neon w-100"><i class="fas fa-microchip"></i> INICIAR ANÁLISE PROFUNDA</button>
        </form>
    </div>

    <!-- History/Previous Analyses -->
    <h5 class="mt-5">Histórico Recente</h5>
    <div class="row" id="historyContainer">
        <% if (history && history.length > 0) { %>
            <% history.forEach(opp => { %>
                <div class="col-md-4 mb-3">
                    <div class="card h-100 history-card" onclick='openHistory(<%- JSON.stringify(opp) %>)'>
                        <div class="card-body">
                            <h6 class="card-title text-truncate"><%= opp.title %></h6>
                            <p class="small text-muted"><%= opp.municipality %></p>
                            <span class="badge bg-warning text-dark">IPM: <%= opp.ipm_score %></span>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <p class="text-muted text-center">Nenhuma análise realizada ainda.</p>
        <% } %>
    </div>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay">
    <div class="container">
        <div class="scanner-line"></div>
        <h3 class="text-white mb-3">PROCESSANDO EDITAL</h3>
        <div id="currentThoughtTitle">INICIALIZANDO NEURÔNIOS...</div>
        <p class="text-muted mt-3" id="loadingDetails">Aguarde, a I.A. está lendo o documento...</p>
    </div>
</div>

<!-- RESULT MODAL (Full Screen Overlay effectively) -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalTitle">Resultado da Análise</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resultBody">
                <!-- Dynamic Content Here -->
            </div>
            <div class="modal-footer border-secondary">
                <form action="/create" method="POST" id="sniperForm">
                    <input type="hidden" name="name" id="sniperName">
                    <input type="hidden" name="cep" value="00000-000"> <!-- Default or user prompt? -->
                    <input type="hidden" name="gridData" id="sniperGridData">
                    <input type="hidden" name="metadataJSON" id="sniperMetadata">
                    <input type="hidden" name="moduleName" value="gemini_meli"> <!-- Default module -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-crosshairs"></i> ENVIAR PARA O SNIPER</button>
                </form>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    const form = document.getElementById('uploadForm');
    const overlay = document.getElementById('loadingOverlay');
    const thoughtTitle = document.getElementById('currentThoughtTitle');
    const loadingDetails = document.getElementById('loadingDetails');
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
    const resultBody = document.getElementById('resultBody');

    // History Handler
    window.openHistory = function(opp) {
        // Construct standard data object format from DB opportunity
        // DB opportunity has 'metadata', 'locked_content', 'items' as JSON columns usually
        // Note: The template injects the object as JSON.

        // Ensure structure matches renderResult
        const data = {
            metadata: opp.metadata || {},
            locked_content: opp.locked_content || {},
            items: opp.items || []
        };

        // Fill defaults if missing (older data)
        if (!data.metadata.ipm_score) data.metadata.ipm_score = opp.ipm_score;
        if (!data.metadata.edital_numero) data.metadata.edital_numero = opp.title;
        if (!data.metadata.municipio_uf) data.metadata.municipio_uf = opp.municipality;

        renderResult(data);
        resultModal.show();
    };

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        overlay.style.display = 'flex';
        thoughtTitle.innerText = "CONECTANDO AO ORÁCULO...";

        const formData = new FormData(form);

        try {
            // Use fetch to initiate the request
            const response = await fetch('/api/process-tr', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;

                // Process events from buffer (SSE format: event: ... \n data: ... \n\n)
                const lines = buffer.split('\n');
                // Keep the last partial line in buffer
                buffer = lines.pop();

                let currentEvent = null;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    if (line.startsWith('event: ')) {
                        currentEvent = line.substring(7).trim();
                    } else if (line.startsWith('data: ') && currentEvent) {
                        const dataStr = line.substring(6);
                        try {
                            const data = JSON.parse(dataStr);
                            handleServerEvent(currentEvent, data);
                        } catch (e) {
                            if (dataStr === '"DONE"') {
                                // End of stream
                            }
                        }
                        currentEvent = null; // Reset for next event
                    }
                }
            }

            overlay.style.display = 'none';

        } catch (error) {
            console.error(error);
            overlay.style.display = 'none';
            alert("Erro ao processar: " + error.message);
        }
    });

    function handleServerEvent(type, data) {
        if (type === 'status') {
            loadingDetails.innerText = data.message;
        } else if (type === 'thought') {
            thoughtTitle.innerText = data.title;
            // Add a small fade effect or log
            console.log("Thought:", data.title);
        } else if (type === 'result') {
            renderResult(data);
            resultModal.show();
        } else if (type === 'error') {
            alert("Erro da IA: " + data.message);
            overlay.style.display = 'none';
        }
    }

    function renderResult(data) {
        const meta = data.metadata || {};
        const locked = data.locked_content || {};
        const items = data.items || [];

        const color = meta.cor_hex || '#fff';

        // Prepare Sniper Form Data
        document.getElementById('sniperName').value = meta.edital_numero || 'Nova Tarefa';
        document.getElementById('sniperMetadata').value = JSON.stringify(meta);

        // Format Items for Grid CSV (ID;Description;Price;Qty)
        let csvContent = "ID;Descricao;valor_venda;quantidade\n";
        items.forEach(item => {
            csvContent += `${item.id};${item.description.replace(/;/g, ',')};${item.valor_venda || 0};${item.quantidade || 1}\n`;
        });
        document.getElementById('sniperGridData').value = csvContent;

        let tagsHtml = '';
        if (meta.tags_estrategicas && Array.isArray(meta.tags_estrategicas)) {
            tagsHtml = meta.tags_estrategicas.map(t => `<span class="tag-badge">${t}</span>`).join('');
        }

        let highlightsHtml = '';
        if (locked.itens_destaque && Array.isArray(locked.itens_destaque)) {
            highlightsHtml = locked.itens_destaque.map(i => `<div class="highlight-item"><i class="fas fa-check text-success"></i> ${i}</div>`).join('');
        }

        let risksHtml = '';
        if (locked.armadilhas_identificadas && Array.isArray(locked.armadilhas_identificadas)) {
            risksHtml = locked.armadilhas_identificadas.map(r => `<div class="risk-item"><i class="fas fa-exclamation-triangle"></i> ${r}</div>`).join('');
        }

        const formattedPrice = meta.valor_estimado_total || 'N/A';

        resultBody.innerHTML = `
            <div class="result-header text-center">
                <h2 style="color: ${color}">${meta.classificacao_oportunidade || 'ANÁLISE CONCLUÍDA'}</h2>
                <h4>${meta.edital_numero || ''} - ${meta.municipio_uf || ''}</h4>
                <p class="lead text-muted">${meta.tipo_objeto_principal || ''}</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-box">
                        <div class="metric-value" style="color: ${color}">${meta.ipm_score || 0}</div>
                        <div class="metric-label">IPM Score</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <div class="metric-value text-white" style="font-size: 1.2rem">${formattedPrice}</div>
                        <div class="metric-label">Valor Total</div>
                    </div>
                </div>
                 <div class="col-md-6">
                    <div class="metric-box text-start">
                        <div class="metric-label mb-2">Resumo Estratégico</div>
                        <p class="small mb-0 text-white">"${meta.resumo_teaser || '...'}"</p>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                ${tagsHtml}
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="section-title">PERFIL DO VENCEDOR</div>
                    <p>${locked.perfil_vencedor || 'Não identificado'}</p>

                    <div class="section-title">ITENS DE DESTAQUE</div>
                    ${highlightsHtml}
                </div>
                <div class="col-md-6">
                    <div class="section-title text-danger">ARMADILHAS & RISCOS</div>
                    ${risksHtml}
                </div>
            </div>

            <hr class="border-secondary my-4">

            <div class="section-title">ANÁLISE DETALHADA (IPM)</div>
            <div class="bg-dark p-3 rounded border border-secondary text-muted small" style="white-space: pre-wrap;">
                ${locked.analise_markdown ? locked.analise_markdown.replace(/\*\*/g, '').replace(/###/g, '') : ''}
            </div>
        `;
    }
</script>
