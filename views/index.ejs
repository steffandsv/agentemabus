<%- include('partials/header') %>

<style>
    .kanban-board {
        display: flex;
        gap: 1.5rem;
        overflow-x: auto;
        padding-bottom: 20px;
        min-height: 80vh;
    }
    .kanban-column {
        flex: 1;
        min-width: 300px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }
    .kanban-column-header {
        font-weight: bold;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    .kanban-card {
        background: white;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid transparent;
        position: relative;
    }
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .kanban-card.status-running, .kanban-card.status-queued { border-left-color: #0d6efd; }
    .kanban-card.status-completed { border-left-color: #198754; }
    .kanban-card.status-failed { border-left-color: #dc3545; }
    .kanban-card.status-pending { border-left-color: #6c757d; }

    .card-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-bottom: 0.5rem;
    }
    .tag-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        color: white;
    }
    .ghost-card {
        background: #e9ecef;
        border: 2px dashed #adb5bd;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üöÄ Painel de Miss√µes</h1>
    <a href="/create" class="btn btn-primary">‚ûï Nova Cota√ß√£o</a>
</div>

<div class="kanban-board">
    <!-- Aguardando -->
    <div class="kanban-column" id="col-pending">
        <div class="kanban-column-header">
            <span>‚è≥ Aguardando</span>
            <span class="badge bg-secondary"><%= tasks.filter(t => t.status === 'pending').length %></span>
        </div>
        <div class="kanban-list" data-status="pending">
            <% tasks.filter(t => t.status === 'pending').forEach(task => { %>
                <%- include('partials/card', { task: task }) %>
            <% }) %>
        </div>
    </div>

    <!-- Em Cota√ß√£o -->
    <div class="kanban-column" id="col-running">
        <div class="kanban-column-header">
            <span>üìä Em Cota√ß√£o</span>
            <span class="badge bg-primary"><%= tasks.filter(t => t.status === 'running' || t.status === 'queued').length %></span>
        </div>
        <div class="kanban-list" data-status="running">
            <% tasks.filter(t => t.status === 'running' || t.status === 'queued').forEach(task => { %>
                <%- include('partials/card', { task: task }) %>
            <% }) %>
        </div>
    </div>

    <!-- Conclu√≠do -->
    <div class="kanban-column" id="col-completed">
        <div class="kanban-column-header">
            <span>‚úÖ Conclu√≠do</span>
            <span class="badge bg-success"><%= tasks.filter(t => t.status === 'completed').length %></span>
        </div>
        <div class="kanban-list" data-status="completed">
            <% tasks.filter(t => t.status === 'completed').forEach(task => { %>
                <%- include('partials/card', { task: task }) %>
            <% }) %>
        </div>
    </div>

    <!-- Erro -->
    <div class="kanban-column" id="col-failed">
        <div class="kanban-column-header">
            <span>‚ö†Ô∏è Erros / Abortados</span>
            <span class="badge bg-danger"><%= tasks.filter(t => t.status === 'failed' || t.status === 'aborted').length %></span>
        </div>
        <div class="kanban-list" data-status="failed">
            <% tasks.filter(t => t.status === 'failed' || t.status === 'aborted').forEach(task => { %>
                <%- include('partials/card', { task: task }) %>
            <% }) %>
        </div>
    </div>
</div>

<!-- Modal Tags -->
<div class="modal fade" id="tagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gerenciar Tags</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="tagTaskId">
                <div class="mb-3">
                    <label>Nome da Tag</label>
                    <input type="text" class="form-control" id="tagName" placeholder="Ex: Prioridade Alta">
                </div>
                <div class="mb-3">
                    <label>Cor</label>
                    <input type="color" class="form-control form-control-color" id="tagColor" value="#563d7c">
                </div>
                <button type="button" class="btn btn-primary w-100" onclick="addTag()">Adicionar Tag</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    // Only allow sorting within Pending list
    const pendingList = document.querySelector('#col-pending .kanban-list');
    if (pendingList) {
        new Sortable(pendingList, {
            group: 'pending', // Unique group name prevents dragging to other columns
            animation: 150,
            ghostClass: 'ghost-card',
            onEnd: function (evt) {
                const newIndex = evt.newIndex;
                const cards = pendingList.querySelectorAll('.kanban-card');
                const orderedIds = Array.from(cards).map(c => c.dataset.id);

                fetch('/api/tasks/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderedIds: orderedIds })
                });
            }
        });
    }

    function openTagModal(taskId) {
        event.stopPropagation(); // Prevent card click
        document.getElementById('tagTaskId').value = taskId;
        var modal = new bootstrap.Modal(document.getElementById('tagModal'));
        modal.show();
    }

    function addTag() {
        const id = document.getElementById('tagTaskId').value;
        const name = document.getElementById('tagName').value;
        const color = document.getElementById('tagColor').value;

        if(!name) return;

        let tags = []; 
        // Logic to fetch existing not implemented in frontend state, simplistic add
        tags.push({ name, color });

        // We should really append to existing on backend, but our API replaces.
        // For now, let's just send the new one and let backend handle or overwrite (simple limitation).
        // To fix: read data-tags attribute again.
        const card = document.querySelector(`.kanban-card[data-id="${id}"]`);
        try {
            const existing = JSON.parse(card.dataset.tags || '[]');
            tags = [...existing, { name, color }];
        } catch(e) {}

        fetch(`/api/tasks/${id}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tags })
        }).then(() => location.reload()); 
    }
</script>

<%- include('partials/footer') %>
