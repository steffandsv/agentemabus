name: Deploy Agente Mabus

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}            
          username: ${{ secrets.USERNAME }}    
          password: ${{ secrets.PASSWORD }}     
          port: 2222                            
          script: |
            # --- 1. PREPARAÇÃO DO AMBIENTE ---
            echo "${{ secrets.PASSWORD }}" | sudo -S mkdir -p /opt/agente-mabus
            echo "${{ secrets.PASSWORD }}" | sudo -S chown -R $USER:$USER /opt/agente-mabus
            
            cd /opt/agente-mabus
            
            # --- 2. ATUALIZAÇÃO DO CÓDIGO (GIT) ---
            if [ ! -d ".git" ]; then
              git clone https://github.com/steffandsv/agentemabus.git .
            else
              git fetch origin
              git reset --hard origin/main
            fi
            
            # --- 3. GERAÇÃO DO ARQUIVO .ENV ---
            # Aqui garantimos que todas as variáveis vão para o arquivo
            echo "DB_HOST=srv466.hstgr.io" > .env
            echo "DB_DB=${{ secrets.DB_DB }}" >> .env
            echo "DB_USER=${{ secrets.DB_USER }}" >> .env
            echo "DB_PASS=${{ secrets.DB_PASS }}" >> .env
            echo "QWEN_KEY=${{ secrets.QWEN_KEY }}" >> .env
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
            echo "GOOGLE_SEARCH_API_KEY=${{ secrets.GOOGLE_SEARCH_API_KEY }}" >> .env
            echo "GOOGLE_SEARCH_CX=${{ secrets.GOOGLE_SEARCH_CX }}" >> .env
            echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" >> .env
            echo "PERPLEXITY_API_KEY=${{ secrets.PERPLEXITY_API_KEY }}" >> .env
            echo "COOKIES_B64=${{ secrets.COOKIES_B64 }}" >> .env
            
            # --- 4. EXECUÇÃO DO DOCKER ---
            echo "${{ secrets.PASSWORD }}" | sudo -S docker compose down
            
            # AQUI ESTÁ O TRUQUE: --env-file .env
            echo "${{ secrets.PASSWORD }}" | sudo -S docker compose --env-file .env up -d --build --force-recreate --remove-orphans
            
            # --- 5. LIMPEZA ---
            echo "${{ secrets.PASSWORD }}" | sudo -S docker image prune -f
