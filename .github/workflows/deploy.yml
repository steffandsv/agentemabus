name: Deploy Agente Mabus

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}      # IP: 45.172.145.202
          username: ${{ secrets.USERNAME }} # User: steffan
          password: ${{ secrets.PASSWORD }} # Pass: a2312steff
          port: 2222                    # Porta SSH customizada
          script: |
            # 1. Prepara diretório e permissões
            echo "${{ secrets.PASSWORD }}" | sudo -S mkdir -p /opt/agente-mabus
            echo "${{ secrets.PASSWORD }}" | sudo -S chown -R $USER:$USER /opt/agente-mabus
            
            # 2. Navega para a pasta
            cd /opt/agente-mabus
            
            # 3. Atualiza o código (Reset hard garante que a versão do servidor seja idêntica ao git)
            if [ ! -d ".git" ]; then
              git clone https://github.com/steffandsv/agentemabus.git .
            else
              git fetch origin
              git reset --hard origin/main
            fi
            
            # 4. Gera o arquivo .env
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
            echo "GOOGLE_SEARCH_API_KEY=${{ secrets.GOOGLE_SEARCH_API_KEY }}" >> .env
            echo "GOOGLE_SEARCH_CX=${{ secrets.GOOGLE_SEARCH_CX }}" >> .env
            echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" >> .env
            
            # 5. Gera o arquivo de cookies (Decodifica Base64)
            echo "${{ secrets.COOKIES_B64 }}" | base64 -d > cookies.json            
            
            # 6. Reinicia os containers com a nova build
            # Usa sudo -S para passar a senha via pipe
            echo "${{ secrets.PASSWORD }}" | sudo -S docker compose down
            echo "${{ secrets.PASSWORD }}" | sudo -S docker compose up -d --build --remove-orphans
            
            # 7. Limpeza de imagens antigas para economizar espaço no VPS
            echo "${{ secrets.PASSWORD }}" | sudo -S docker image prune -f
