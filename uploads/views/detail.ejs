<%- include('partials/header') %>

<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
    <div>
        <h2 class="text-2xl font-bold text-base-content"><%= task.name %></h2>
        <div class="flex items-center gap-3 text-sm text-base-content/60 mt-1">
            <span class="flex items-center gap-1"><i class="fas fa-cube"></i> <%= task.id %></span>
            <span>|</span>
            <span class="flex items-center gap-1"><i class="fas fa-map-marker-alt"></i> <%= task.cep %></span>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <a href="/dashboard" class="btn btn-ghost btn-sm"><i class="fas fa-arrow-left"></i> VOLTAR</a>
        <% if (task.status === 'running' || task.status === 'pending') { %>
            <button onclick="abortMission()" class="btn btn-error btn-sm text-white"><i class="fas fa-ban"></i> ABORTAR MISSÃO</button>
        <% } %>
        <%
           const anyUnlocked = taskItems.some(item => item.is_unlocked);
           if (task.status !== 'pending' && anyUnlocked) {
        %>
             <a href="/download/<%= task.id %>" class="btn btn-success btn-sm text-white"><i class="fas fa-file-excel"></i> RELATÓRIO (DESBLOQUEADOS)</a>
        <% } %>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- LEFT: SNIPER LIST -->
    <div class="lg:col-span-2 space-y-6">

        <!-- STATUS BAR -->
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-4 flex-row justify-between items-center">
                <span class="text-xs font-bold uppercase opacity-60">STATUS DA MISSÃO</span>
                <div>
                    <% if (task.status === 'running') { %>
                        <div class="badge badge-info gap-2 text-white p-3"><span class="loading loading-spinner loading-xs"></span> ESCANEANDO MERCADO...</div>
                    <% } else if (task.status === 'completed') { %>
                        <div class="badge badge-success gap-2 text-white p-3"><i class="fas fa-check-circle"></i> CONCLUÍDO</div>
                    <% } else { %>
                        <div class="badge badge-ghost p-3"><%= task.status.toUpperCase() %></div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- ITEMS GRID -->
        <div class="card bg-base-100 shadow-sm border border-base-200 overflow-hidden">
            <div class="p-4 border-b border-base-200 bg-base-100/50 flex items-center gap-2">
                <i class="fas fa-list-ol text-primary"></i> <span class="font-bold">RESULTADOS DA COTAÇÃO</span>
            </div>
            <div class="overflow-x-auto">
                <table class="table w-full text-sm">
                    <thead>
                        <tr class="bg-base-200 text-base-content/60 uppercase text-xs">
                            <th>ITEM</th>
                            <th>MARCA / MODELO</th>
                            <th class="text-right">TETO (R$)</th>
                            <th class="text-right">ENCONTRADO (R$)</th>
                            <th class="text-center">MARGEM</th>
                            <th class="text-center">LINK</th>
                            <th class="text-right">AÇÃO</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (taskItems.length === 0) { %>
                            <tr><td colspan="5" class="text-center py-8 opacity-50">Aguardando dados...</td></tr>
                        <% } %>
                        <% taskItems.forEach(item => {
                            const hasPrice = item.best_price > 0;
                            const profit = item.valor_venda - item.best_price;
                            const margin = (profit / item.valor_venda) * 100;
                            const isWin = hasPrice && profit >= 0;
                            const isUnlocked = item.is_unlocked;
                        %>
                        <tr class="hover:bg-base-200/50">
                            <td class="max-w-xs">
                                <div class="font-bold truncate" title="<%= item.description %>"><%= item.description %></div>
                                <div class="text-xs text-base-content/60">Qtd: <%= item.quantidade %></div>
                            </td>
                            <td>
                                <% if (isUnlocked && item.winner) { %>
                                    <div class="text-xs font-bold" title="<%= item.winner.title %>"><%= item.winner.brand_model || item.winner.title || 'N/A' %></div>
                                <% } else { %>
                                    <div class="text-xs text-base-content/30 select-none">**** / *****</div>
                                <% } %>
                            </td>
                            <td class="text-right font-mono"><%= item.valor_venda.toFixed(2) %></td>
                            <td class="text-right font-mono">
                                <% if (hasPrice) { %>
                                    <% if (isUnlocked) { %>
                                        <span class="<%= isWin ? 'text-success' : 'text-error' %> font-bold">
                                            R$ <%= item.best_price.toFixed(2) %>
                                        </span>
                                    <% } else { %>
                                        <span class="text-base-content/30 select-none">R$ ***,**</span>
                                    <% } %>
                                <% } else { %>
                                    <span class="text-base-content/30">---</span>
                                <% } %>
                            </td>
                            <td class="text-center">
                                <% if (isWin) { %>
                                    <div class="badge badge-success badge-sm text-white gap-1"><i class="fas fa-arrow-up"></i> <%= margin.toFixed(0) %>%</div>
                                <% } else if (hasPrice) { %>
                                    <div class="badge badge-error badge-sm text-white gap-1"><i class="fas fa-arrow-down"></i></div>
                                <% } else { %>
                                    <% if (task.status === 'running') { %>
                                        <span class="loading loading-spinner loading-xs opacity-50"></span>
                                    <% } else { %>
                                        <span class="opacity-30">-</span>
                                    <% } %>
                                <% } %>
                            </td>
                            <td class="text-center">
                                <% if (isUnlocked && item.winner && item.winner.link) { %>
                                    <a href="<%= item.winner.link %>" target="_blank" class="btn btn-xs btn-ghost text-info"><i class="fas fa-external-link-alt"></i></a>
                                <% } else { %>
                                    <button class="btn btn-xs btn-ghost text-base-content/20" disabled><i class="fas fa-link"></i></button>
                                <% } %>
                            </td>
                            <td class="text-right">
                                <% if (hasPrice) { %>
                                    <% if (isUnlocked) { %>
                                        <a href="/download/<%= task.id %>/item/<%= item.db_id || item.id %>" class="btn btn-square btn-sm btn-ghost text-success" title="Baixar Item">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    <% } else { %>
                                        <button onclick="unlockItem('<%= item.db_id || item.id %>')" class="btn btn-sm btn-outline btn-warning gap-1 text-xs">
                                            <i class="fas fa-lock"></i> 150
                                        </button>
                                    <% } %>
                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- RIGHT: LOGS & STATS -->
    <div class="space-y-6">

        <!-- LOGS TOGGLE -->
        <div class="collapse collapse-arrow border border-base-200 bg-base-100 shadow-sm">
            <input type="checkbox" />
            <div class="collapse-title text-sm font-bold flex items-center gap-2">
                <i class="fas fa-terminal"></i> LOGS DO SISTEMA
            </div>
            <div class="collapse-content bg-base-200/50 p-0">
                <pre id="logs" class="p-4 text-xs font-mono h-[300px] overflow-y-auto bg-black/5 text-base-content/70"></pre>
            </div>
        </div>

        <!-- STATS CARD -->
        <div class="card bg-base-100 border-2 border-warning/20 shadow-lg">
            <div class="card-body items-center text-center">
                <h6 class="text-xs font-bold uppercase opacity-60 mb-2">LUCRO PROJETADO (POTENCIAL)</h6>
                <%
                    let totalProfit = 0;
                    let lockedCount = 0;
                    taskItems.forEach(i => {
                        if (i.best_price > 0 && i.best_price < i.valor_venda) {
                            totalProfit += (i.valor_venda - i.best_price) * i.quantidade;
                        }
                        if (!i.is_unlocked) lockedCount++;
                    });

                    const unlockAllCost = lockedCount * 75;
                %>
                <h2 class="text-4xl font-black text-warning tracking-tight">R$ <%= totalProfit.toFixed(2) %></h2>

                <% if (lockedCount > 0) { %>
                    <div class="mt-6 w-full">
                        <p class="text-xs text-center opacity-60 mb-3"><%= lockedCount %> Itens Bloqueados</p>
                        <button onclick="unlockAll()" class="btn btn-warning w-full shadow-lg text-black font-bold">
                            <div class="flex flex-col items-center leading-none">
                                <span class="flex items-center gap-2"><i class="fas fa-bolt"></i> DESBLOQUEAR TUDO (<%= unlockAllCost %> W)</span>
                                <span class="text-[10px] font-normal opacity-80 mt-1">50% DE DESCONTO APLICADO</span>
                            </div>
                        </button>
                    </div>
                <% } else { %>
                    <div class="mt-6 w-full space-y-2">
                        <div class="alert alert-success bg-success/10 text-success border-success/20 flex justify-center text-sm font-bold">
                            <i class="fas fa-check-circle"></i> ACESSO TOTAL LIBERADO
                        </div>
                        <a href="/download/<%= task.id %>" class="btn btn-primary w-full shadow-lg text-white font-bold">
                            <i class="fas fa-file-excel"></i> BAIXAR PLANILHA COMPLETA
                        </a>
                    </div>
                <% } %>
            </div>
        </div>

    </div>
</div>

<script>
    const taskId = '<%= task.id %>';

    // Logs handled by DaisyUI collapse component (checkbox)

    // Simple Log Fetcher
    setInterval(() => {
        fetch('/api/logs/' + taskId)
            .then(r => r.text())
            .then(text => {
                const el = document.getElementById('logs');
                if (el.innerText !== text) {
                    el.innerText = text;
                    el.scrollTop = el.scrollHeight;
                }
            });
    }, 2000);

    async function abortMission() {
        if (!confirm('Tem certeza? Isso irá parar o processo e não poderá ser revertido.')) return;
        try {
            const res = await fetch('/api/task/' + taskId + '/abort', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch(e) { alert('Erro de conexão'); }
    }

    async function unlockItem(itemDbId) {
        if (!confirm('Desbloquear este item por 150 Watts?')) return;
        try {
            const res = await fetch('/api/unlock-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ itemId: itemDbId })
            });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erro: ' + (data.error || 'Saldo insuficiente ou erro desconhecido.'));
            }
        } catch(e) { alert('Erro de conexão'); }
    }

    async function unlockAll() {
        if (!confirm('Desbloquear TODOS os itens com 50% de desconto?')) return;
        try {
            const res = await fetch('/api/unlock-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId: taskId })
            });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erro: ' + (data.error || 'Saldo insuficiente ou erro desconhecido.'));
            }
        } catch(e) { alert('Erro de conexão'); }
    }

    // Auto-refresh page on completion
    const currentStatus = '<%= task.status %>';
    if (currentStatus === 'running' || currentStatus === 'pending') {
        setTimeout(() => {
           window.location.reload();
        }, 10000);
    }
</script>

<%- include('partials/footer') %>
